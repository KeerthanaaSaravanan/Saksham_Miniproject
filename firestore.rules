/**
 * @fileoverview Firestore Security Rules for Saksham Application
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal data and leverages denormalization to optimize authorization checks, avoiding costly `get()` calls.
 *
 * Data Structure:
 * - User profiles are stored under `/users/{userId}`.
 * - Learning modules are stored under `/learning_modules/{learningModuleId}`.
 * - Exams are stored under `/exams/{examId}`.
 * - Questions related to exams are under `/exams/{examId}/questions/{questionId}`.
 * - Student exam attempts are nested under `/users/{userId}/exam_attempts/{studentExamAttemptId}`.
 * - Student answers are nested under `/users/{userId}/exam_attempts/{studentExamAttemptId}/answers/{studentAnswerId}`.
 * - Accessibility profiles are stored under `/users/{userId}/accessibility_profile/{accessibilityProfileId}`.
 *
 * Key Security Decisions:
 * - Users can only read and write their own user document and related subcollections (exam attempts, answers, accessibility profile).
 * - Listing of user documents is disallowed.
 * - Learning modules and exams can be read by anyone.
 * - Data denormalization is used to avoid expensive `get()` calls in rules.
 *
 * Denormalization for Authorization:
 * - StudentExamAttempt includes `userId` and `examId` to avoid needing to fetch the User or Exam document for authorization.
 * - StudentAnswer includes `studentExamAttemptId` and `questionId` to avoid needing to fetch the StudentExamAttempt or Question document.
 * - LearningModule and Exam include `gradeLevel` to allow secure list operations (QAPs).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure access to user profile information.
     * @path /users/{userId}
     * @allow (get, list) if request.auth.uid == userId
     * @allow (create, update, delete) if request.auth.uid == userId
     * @deny (get, list) if request.auth.uid != userId
     * @deny (create, update, delete) if request.auth.uid != userId
     * @principle Enforces document ownership: Only the authenticated user can read/write their own profile.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Listing users is not permitted.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);

      /**
       * @description Secure access to user's accessibility profile.
       * @path /users/{userId}/accessibility_profile/{accessibilityProfileId}
       * @allow (get, list) if request.auth.uid == userId
       * @allow (create, update, delete) if request.auth.uid == userId
       * @deny (get, list) if request.auth.uid != userId
       * @deny (create, update, delete) if request.auth.uid != userId
       * @principle Enforces document ownership: Only the authenticated user can read/write their own accessibility profile.
       */
      match /accessibility_profile/{accessibilityProfileId} {
        allow read, write: if isOwner(userId);
      }

      /**
       * @description Secure access to student exam attempts.
       * @path /users/{userId}/exam_attempts/{studentExamAttemptId}
       * @allow (get, list) if request.auth.uid == userId
       * @allow (create, update, delete) if request.auth.uid == userId
       * @deny (get, list) if request.auth.uid != userId
       * @deny (create, update, delete) if request.auth.uid != userId
       * @principle Enforces document ownership: Only the authenticated user can read/write their own exam attempts.
       */
      match /exam_attempts/{studentExamAttemptId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
        allow delete: if isExistingOwner(userId);

        /**
         * @description Secure access to student answers within an exam attempt.
         * @path /users/{userId}/exam_attempts/{studentExamAttemptId}/answers/{studentAnswerId}
         * @allow (get, list) if request.auth.uid == userId
         * @allow (create, update, delete) if request.auth.uid == userId
         * @deny (get, list) if request.auth.uid != userId
         * @deny (create, update, delete) if request.auth.uid != userId
         * @principle Enforces document ownership: Only the authenticated user can read/write their own answers.
         */
        match /answers/{studentAnswerId} {
          allow get: if isOwner(userId);
          allow list: if isOwner(userId);
          allow create: if isOwner(userId) && request.resource.data.studentExamAttemptId == studentExamAttemptId;
          allow update: if isExistingOwner(userId) && request.resource.data.studentExamAttemptId == resource.data.studentExamAttemptId;
          allow delete: if isExistingOwner(userId);
        }
      }
    }

    /**
     * @description Public access to learning modules.
     * @path /learning_modules/{learningModuleId}
     * @allow get, list: if true
     * @deny create, update, delete: if true
     * @principle Public read access with no write access.
     */
    match /learning_modules/{learningModuleId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Public access to exams.
     * @path /exams/{examId}
     * @allow get, list: if true
     * @deny create, update, delete: if true
     * @principle Public read access with no write access.
     */
    match /exams/{examId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.

      /**
       * @description Secure access to questions associated with an exam.
       * @path /exams/{examId}/questions/{questionId}
       */
      match /questions/{questionId} {
           allow get, list: if true;
           allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      }
    }
  }
}
