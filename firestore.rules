/**
 * @fileOverview Firestore Security Rules for the Saksham application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for private user data and allows public read access to learning modules and exams. All write operations are protected by authorization checks.  Data validation is relaxed for prototyping, but relational integrity is maintained.
 *
 * Data Structure:
 * - User profiles are stored under `/users/{userId}`, ensuring that user-specific data is isolated and access-controlled.
 * - Learning modules are stored under `/learning_modules/{learningModuleId}`.
 * - Exams are stored under `/exams/{examId}`.
 * - Questions are stored under `/exams/{examId}/questions/{questionId}`.
 * - Student exam attempts and student answers are nested under `/users/{userId}` to represent the user's activity and ownership.
 * - Accessibility profiles are stored under `/users/{userId}/accessibility_profile/{accessibilityProfileId}`.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - Public read access is granted for learning modules and exams.
 * - Ownership is enforced for user-specific data through path-based checks and data denormalization.
 * - Relational integrity is maintained by validating relationships between documents during creation and updates.
 *
 * Denormalization for Authorization:
 * - StudentExamAttempt includes userId and examId. StudentAnswer includes studentExamAttemptId and questionId. This avoids the need for `get()` calls in security rules to validate ownership or access rights.
 * - LearningModule and Exam store gradeLevel. This enables secure list operations by allowing queries filtered by gradeLevel without requiring client-side filtering.
 *
 * Structural Segregation:
 * - User profiles are separated from learning modules and exams, ensuring that user-specific data is isolated and access-controlled.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces document ownership for user profiles. Only the user can read/write their own profile.
     * @path /users/{userId}
     * @allow (get, create, update, delete) if the user is signed in and the userId matches the authenticated user's UID.
     * @deny (get, create, update, delete) if the user is not signed in, or the userId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // User listing is explicitly disallowed.
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to learning modules, but restricts write access to authorized users.
     * @path /learning_modules/{learningModuleId}
     * @allow (get, list) any signed in user to read and list learning modules.
     * @allow (create, update, delete) if false; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @deny (create, update, delete) always unless ownership field exists.
     * @principle Allows public read access with owner-only writes.
     */
    match /learning_modules/{learningModuleId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to exams, but restricts write access to authorized users.
     * @path /exams/{examId}
     * @allow (get, list) any signed in user to read and list exams.
     * @allow (create, update, delete) if false; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @deny (create, update, delete) always unless ownership field exists.
     * @principle Allows public read access with owner-only writes.
     */
    match /exams/{examId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Enforces document ownership for questions nested under exams.
     * @path /exams/{examId}/questions/{questionId}
     * @allow (get, list) any signed in user to read and list questions.
     * @allow (create, update, delete) if false; // TODO: Add owner validation once the schema is updated with an ownership field.
     * @deny (create, update, delete) always unless ownership field exists.
     * @principle Enforces document ownership for writes.
     */
    match /exams/{examId}/questions/{questionId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Enforces document ownership for student exam attempts nested under users.
     * @path /users/{userId}/exam_attempts/{studentExamAttemptId}
     * @allow (get, list, create, update, delete) if the user is signed in and the userId matches the authenticated user's UID.
     * @deny (get, list, create, update, delete) if the user is not signed in, or the userId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/exam_attempts/{studentExamAttemptId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces document ownership for student answers nested under student exam attempts.
     * @path /users/{userId}/exam_attempts/{studentExamAttemptId}/answers/{studentAnswerId}
     * @allow (get, list, create, update, delete) if the user is signed in and the userId matches the authenticated user's UID.
     * @deny (get, list, create, update, delete) if the user is not signed in, or the userId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/exam_attempts/{studentExamAttemptId}/answers/{studentAnswerId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces document ownership for accessibility profiles nested under users.
     * @path /users/{userId}/accessibility_profile/{accessibilityProfileId}
     * @allow (get, list, create, update, delete) if the user is signed in and the userId matches the authenticated user's UID.
     * @deny (get, list, create, update, delete) if the user is not signed in, or the userId does not match the authenticated user's UID.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/accessibility_profile/{accessibilityProfileId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}