/**
  * @file Overview
  * This ruleset enforces a strict user-ownership model for private user data stored under `/users/{userId}` and its subcollections,
  * while allowing public read access to learning modules and exams.
  *
  * @data-structure
  * - /users/{userId}: Stores private user profile information.
  * - /learning_modules/{learningModuleId}: Stores publicly accessible learning modules.
  * - /exams/{examId}: Stores publicly accessible exam information.
  * - /exams/{examId}/questions/{questionId}: Stores questions associated with an exam.
  * - /users/{userId}/exam_attempts/{studentExamAttemptId}: Stores a user's exam attempts.
  * - /users/{userId}/exam_attempts/{studentExamAttemptId}/answers/{studentAnswerId}: Stores a user's answers for a specific exam attempt.
  * - /users/{userId}/accessibility_profile/{accessibilityProfileId}: Stores a user's accessibility profile.
  *
  * @key-security-decisions
  * - User data is strictly controlled by the owning user.
  * - Public read access is granted to learning modules and exams.
  * - Listing of all users is disallowed.
  * - Strict ownership is enforced on nested data (exam attempts, answers, profiles)
  *   under the `/users/{userId}` path.
  *
  * @denormalization
  * - `StudentExamAttempt` includes `userId` and `examId` to avoid extra reads for
  *   authorization.
  * - `StudentAnswer` includes `studentExamAttemptId` and `questionId` to avoid
  *   extra reads for authorization.
  * - `LearningModule` and `Exam` include `gradeLevel` to allow secure list operations.
  */
 

 rules_version = '2';
 service cloud.firestore {
  match /databases/{database}/documents {
 

  /**
  * @description Enforces user-ownership for user profile data.
  * @path /users/{userId}
  * @allow (create) User with matching Firebase UID can create their profile.
  * @allow (get, update, delete) User with matching Firebase UID can get, update, or delete their profile.
  * @deny (create) User tries to create a profile with a mismatched Firebase UID.
  * @deny (get, update, delete) User tries to get, update, or delete another user's profile.
  * @principle Enforces document ownership for all writes.
  */
  match /users/{userId} {
  function isSignedIn() {
  return request.auth != null;
  }
 

  function isOwner(userId) {
  return request.auth.uid == userId;
  }
 

  function isExistingOwner(userId) {
  return isOwner(userId) && resource != null;
  }
 

  allow get: if isOwner(userId);
  allow list: if false; // Listing all users is not permitted
  allow create: if isSignedIn() && isOwner(userId);
  allow update: if isExistingOwner(userId);
  allow delete: if isExistingOwner(userId);
  }
 

  /**
  * @description Allows public read access to learning modules. Write access is not implemented.
  * @path /learning_modules/{learningModuleId}
  * @allow (get, list) Any user can read learning modules.
  * @deny (create, update, delete) No one can create, update, or delete learning modules via client.
  * @principle Allows public read access with no write access.
  */
  match /learning_modules/{learningModuleId} {
  allow get, list: if true;
  allow create, update, delete: if false;
  }
 

  /**
  * @description Allows public read access to exams. Write access is not implemented.
  * @path /exams/{examId}
  * @allow (get, list) Any user can read exam information.
  * @deny (create, update, delete) No one can create, update, or delete exam information via client.
  * @principle Allows public read access with no write access.
  */
  match /exams/{examId} {
  allow get, list: if true;
  allow create, update, delete: if false;
  }
 

  /**
  * @description Allows read and write to the questions for a specific exam, write access is not implemented.
  * @path /exams/{examId}/questions/{questionId}
  * @allow (get, list) Any user can read exam questions.
  * @deny (create, update, delete) No one can create, update, or delete exam question via client.
  * @principle Allows public read access with no write access.
  */
  match /exams/{examId}/questions/{questionId} {
  allow get, list: if true;
  allow create, update, delete: if false;
  }
 

  /**
  * @description Enforces user-ownership for student exam attempts.
  * @path /users/{userId}/exam_attempts/{studentExamAttemptId}
  * @allow (create) User with matching Firebase UID can create their exam attempt.
  * @allow (get, list, update, delete) User with matching Firebase UID can get, list, update or delete their exam attempt.
  * @deny (create) User tries to create an exam attempt with a mismatched Firebase UID.
  * @deny (get, list, update, delete) User tries to get, list, update, or delete another user's exam attempt.
  * @principle Enforces document ownership for all writes.
  */
  match /users/{userId}/exam_attempts/{studentExamAttemptId} {
  function isSignedIn() {
  return request.auth != null;
  }
 

  function isOwner(userId) {
  return request.auth.uid == userId;
  }
 

  function isExistingOwner(userId) {
  return isOwner(userId) && resource != null;
  }
 

  allow get: if isOwner(userId);
  allow list: if isOwner(userId);
  allow create: if isSignedIn() && isOwner(userId);
  allow update: if isExistingOwner(userId);
  allow delete: if isExistingOwner(userId);
  }
 

  /**
  * @description Enforces user-ownership for student answers within a specific exam attempt.
  * @path /users/{userId}/exam_attempts/{studentExamAttemptId}/answers/{studentAnswerId}
  * @allow (create) User with matching Firebase UID can create their exam answer.
  * @allow (get, list, update, delete) User with matching Firebase UID can get, list, update or delete their exam answer.
  * @deny (create) User tries to create an exam answer with a mismatched Firebase UID.
  * @deny (get, list, update, delete) User tries to get, list, update, or delete another user's exam answer.
  * @principle Enforces document ownership for all writes.
  */
  match /users/{userId}/exam_attempts/{studentExamAttemptId}/answers/{studentAnswerId} {
  function isSignedIn() {
  return request.auth != null;
  }
 

  function isOwner(userId) {
  return request.auth.uid == userId;
  }
 

  function isExistingOwner(userId) {
  return isOwner(userId) && resource != null;
  }
 

  allow get: if isOwner(userId);
  allow list: if isOwner(userId);
  allow create: if isSignedIn() && isOwner(userId);
  allow update: if isExistingOwner(userId);
  allow delete: if isExistingOwner(userId);
  }
 

  /**
  * @description Enforces user-ownership for accessibility profiles.
  * @path /users/{userId}/accessibility_profile/{accessibilityProfileId}
  * @allow (create) User with matching Firebase UID can create their accessibility profile.
  * @allow (get, list, update, delete) User with matching Firebase UID can get, list, update, or delete their accessibility profile.
  * @deny (create) User tries to create an accessibility profile with a mismatched Firebase UID.
  * @deny (get, list, update, delete) User tries to get, list, update, or delete another user's accessibility profile.
  * @principle Enforces document ownership for all writes.
  */
  match /users/{userId}/accessibility_profile/{accessibilityProfileId} {
  function isSignedIn() {
  return request.auth != null;
  }
 

  function isOwner(userId) {
  return request.auth.uid == userId;
  }
 

  function isExistingOwner(userId) {
  return isOwner(userId) && resource != null;
  }
 

  allow get: if isOwner(userId);
  allow list: if isOwner(userId);
  allow create: if isSignedIn() && isOwner(userId);
  allow update: if isExistingOwner(userId);
  allow delete: if isExistingOwner(userId);
  }
  }
 }