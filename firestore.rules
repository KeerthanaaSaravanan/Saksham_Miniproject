/**
 * @file Firestore Security Rules for Saksham Application
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for user-specific data
 * and allows public read access to learning modules and exams while restricting writes to owners.
 *
 * @data_structure
 * - `/users/{userId}`: Stores private user profile data, accessible only by the user themselves.
 * - `/learning_modules/{learningModuleId}`: Stores learning modules, publicly readable.
 * - `/exams/{examId}`: Stores exam data, publicly readable.
 * - `/exams/{examId}/questions/{questionId}`: Stores questions for a specific exam.
 * - `/users/{userId}/exam_attempts/{studentExamAttemptId}`: Stores student's exam attempts, only accessible by the user.
 * - `/users/{userId}/exam_attempts/{studentExamAttemptId}/answers/{studentAnswerId}`: Stores student's answers for an exam attempt, only accessible by the user.
 * - `/users/{userId}/accessibility_profile/{accessibilityProfileId}`: Stores user accessibility profiles, only accessible by the user.
 *
 * @key_security_decisions
 * - User data is strictly private, accessible only to the authenticated user.
 * - Learning modules and exams are publicly readable to facilitate open access to educational content.
 * - Listing of users is disallowed to prevent enumeration.
 * - Data validation is relaxed in prototyping mode, focusing on ownership and relational integrity checks.
 *
 * @denormalization_for_authorization
 * - `StudentExamAttempt` includes `userId` and `examId` to avoid `get()` calls for authorization.
 * - `LearningModule` and `Exam` include `gradeLevel` for secure list operations.
 *
 * @structural_segregation User profiles are separated from learning modules and exams to maintain
 * privacy and control access to sensitive data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces user-ownership for user profile data.
     * @path /users/{userId}
     * @allow (create) User with firebaseUid 'user123' can create their own profile.
     * @allow (get) User with firebaseUid 'user123' can read their own profile.
     * @allow (update) User with firebaseUid 'user123' can update their own profile.
     * @allow (delete) User with firebaseUid 'user123' can delete their own profile.
     * @deny (create) User with firebaseUid 'user456' cannot create a profile for 'user123'.
     * @deny (get) User with firebaseUid 'user456' cannot read profile of 'user123'.
     * @deny (update) User with firebaseUid 'user456' cannot update profile of 'user123'.
     * @deny (delete) User with firebaseUid 'user456' cannot delete profile of 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && existsAfter(resource);
      }

      allow get: if isOwner(userId);
      allow list: if false; // Listing users is not permitted.
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to learning modules.
     * @path /learning_modules/{learningModuleId}
     * @allow (get) Any user can read a learning module.
     * @allow (list) Any user can list learning modules.
     * @deny (create) No one can create learning modules. // TODO: Add owner validation once the schema is updated with an ownership field.
     * @deny (update) No one can update learning modules. // TODO: Add owner validation once the schema is updated with an ownership field.
     * @deny (delete) No one can delete learning modules. // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Allows public read access.
     */
    match /learning_modules/{learningModuleId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows public read access to exam information.
     * @path /exams/{examId}
     * @allow (get) Any user can read exam details.
     * @allow (list) Any user can list exams.
     * @deny (create) No one can create new exams. // TODO: Add owner validation once the schema is updated with an ownership field.
     * @deny (update) No one can update exam details. // TODO: Add owner validation once the schema is updated with an ownership field.
     * @deny (delete) No one can delete exams. // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Allows public read access.
     */
    match /exams/{examId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows read and write for questions for a specific exam.
     * @path /exams/{examId}/questions/{questionId}
     * @allow (get) Any user can read questions for a specific exam.
     * @allow (list) Any user can list questions for a specific exam.
     * @deny (create) No one can create questions for a specific exam. // TODO: Add owner validation once the schema is updated with an ownership field.
     * @deny (update) No one can update questions for a specific exam. // TODO: Add owner validation once the schema is updated with an ownership field.
     * @deny (delete) No one can delete questions for a specific exam. // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Allows public read access.
     */
    match /exams/{examId}/questions/{questionId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Enforces user-ownership for student exam attempts.
     * @path /users/{userId}/exam_attempts/{studentExamAttemptId}
     * @allow (create) User with firebaseUid 'user123' can create their own exam attempt.
     * @allow (get) User with firebaseUid 'user123' can read their own exam attempt.
     * @allow (update) User with firebaseUid 'user123' can update their own exam attempt.
     * @allow (delete) User with firebaseUid 'user123' can delete their own exam attempt.
     * @deny (create) User with firebaseUid 'user456' cannot create an exam attempt for 'user123'.
     * @deny (get) User with firebaseUid 'user456' cannot read exam attempt of 'user123'.
     * @deny (update) User with firebaseUid 'user456' cannot update exam attempt of 'user123'.
     * @deny (delete) User with firebaseUid 'user456' cannot delete exam attempt of 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/exam_attempts/{studentExamAttemptId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && existsAfter(resource);
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for student answers within an exam attempt.
     * @path /users/{userId}/exam_attempts/{studentExamAttemptId}/answers/{studentAnswerId}
     * @allow (create) User with firebaseUid 'user123' can create their own answer.
     *       Requires that the userId of the StudentExamAttempt is user123 as well.
     * @allow (get) User with firebaseUid 'user123' can read their own answer.
     *       Requires that the userId of the StudentExamAttempt is user123 as well.
     * @allow (update) User with firebaseUid 'user123' can update their own answer.
     *       Requires that the userId of the StudentExamAttempt is user123 as well.
     * @allow (delete) User with firebaseUid 'user123' can delete their own answer.
     *       Requires that the userId of the StudentExamAttempt is user123 as well.
     * @deny (create) User with firebaseUid 'user456' cannot create an answer for 'user123'.
     * @deny (get) User with firebaseUid 'user456' cannot read answer of 'user123'.
     * @deny (update) User with firebaseUid 'user456' cannot update answer of 'user123'.
     * @deny (delete) User with firebaseUid 'user456' cannot delete answer of 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/exam_attempts/{studentExamAttemptId}/answers/{studentAnswerId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && existsAfter(resource);
      }
      // Get the UserID from the parent StudentExamAttempt and compare to the current UserID
      function attemptBelongsToUser(userId) {
          return get(/databases/$(database)/documents/users/$(userId)/exam_attempts/$(studentExamAttemptId)).data.userId == userId;
      }
      allow get: if isOwner(userId) && attemptBelongsToUser(userId);
      allow list: if isOwner(userId) && attemptBelongsToUser(userId);
      allow create: if isSignedIn() && isOwner(userId) && attemptBelongsToUser(userId);
      allow update: if isExistingOwner(userId) && attemptBelongsToUser(userId);
      allow delete: if isExistingOwner(userId) && attemptBelongsToUser(userId);
    }

    /**
     * @description Enforces user-ownership for accessibility profiles.
     * @path /users/{userId}/accessibility_profile/{accessibilityProfileId}
     * @allow (create) User with firebaseUid 'user123' can create their own profile.
     * @allow (get) User with firebaseUid 'user123' can read their own profile.
     * @allow (update) User with firebaseUid 'user123' can update their own profile.
     * @allow (delete) User with firebaseUid 'user123' can delete their own profile.
     * @deny (create) User with firebaseUid 'user456' cannot create a profile for 'user123'.
     * @deny (get) User with firebaseUid 'user456' cannot read profile of 'user123'.
     * @deny (update) User with firebaseUid 'user456' cannot update profile of 'user123'.
     * @deny (delete) User with firebaseUid 'user456' cannot delete profile of 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/accessibility_profile/{accessibilityProfileId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && existsAfter(resource);
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}