/**
 * @file Firestore Security Rules for Saksham Application
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for personal data,
 * while allowing public read access to learning modules and exams. User-specific data
 * like profiles, exam attempts, and answers are only accessible to the owning user.
 *
 * @data_structure The Firestore data is organized hierarchically. User profiles are stored
 * under `/users/{userId}`. Learning modules and exams are stored in top-level collections
 * `/learning_modules` and `/exams`, respectively. Student exam attempts and answers are
 * nested under the user's document to represent the user's activity and ownership.
 *
 * @key_security_decisions
 *   - Users can only read and write their own profile data.
 *   - Learning modules and exams are publicly readable but not writable in this prototype.
 *   - Listing of users is explicitly denied to prevent unauthorized data access.
 *   - Exam attempts and answers are strictly owned by the user.
 *
 * @denormalization
 *   - The `StudentExamAttempt` entity includes `userId` and `examId`.
 *   - The `StudentAnswer` entity includes `studentExamAttemptId` and `questionId`.
 *   - The `LearningModule` and `Exam` entities store `gradeLevel`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId and resource exists
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && exists(resource);
    }

    /**
     * @description Enforces document ownership. The user must be signed in and the UID
     * must match the userId in the path.
     * @path /users/{userId}
     * @allow (get, create, update, delete) - Authenticated user with matching UID.
     * @deny (get, create, update, delete) - Unauthenticated user or mismatched UID.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to learning modules.
     * @path /learning_modules/{learningModuleId}
     * @allow (get, list) - Any user can read learning modules.
     * @deny (create, update, delete) - No user can create, update, or delete learning modules.
     * @principle Public read access with no write access.
     */
    match /learning_modules/{learningModuleId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to exams.
     * @path /exams/{examId}
     * @allow (get, list) - Any user can read exam details.
     * @deny (create, update, delete) - No user can create, update, or delete exams.
     * @principle Public read access with no write access.
     */
    match /exams/{examId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to questions within an exam.
     * @path /exams/{examId}/questions/{questionId}
     * @allow (get, list) - Any user can read questions.
     * @deny (create, update, delete) - No user can create, update, or delete questions.
     * @principle Public read access with no write access.
     */
    match /exams/{examId}/questions/{questionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Enforces ownership for student exam attempts. Only the owning user can
     * read, create, update, or delete their own exam attempts.
     * @path /users/{userId}/exam_attempts/{studentExamAttemptId}
     * @allow (get, list, create, update, delete) - Authenticated user with matching UID.
     * @deny (get, list, create, update, delete) - Unauthenticated user or mismatched UID.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/exam_attempts/{studentExamAttemptId} {
      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces ownership for student answers. Only the owning user can
     * read, create, update, or delete their own answers within their exam attempts.
     * @path /users/{userId}/exam_attempts/{studentExamAttemptId}/answers/{studentAnswerId}
     * @allow (get, list, create, update, delete) - Authenticated user with matching UID.
     * @deny (get, list, create, update, delete) - Unauthenticated user or mismatched UID.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/exam_attempts/{studentExamAttemptId}/answers/{studentAnswerId} {
      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces ownership for accessibility profiles. Only the owning user can
     * read, create, update, or delete their own accessibility profile.
     * @path /users/{userId}/accessibility_profile/{accessibilityProfileId}
     * @allow (get, list, create, update, delete) - Authenticated user with matching UID.
     * @deny (get, list, create, update, delete) - Unauthenticated user or mismatched UID.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/accessibility_profile/{accessibilityProfileId} {
      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}