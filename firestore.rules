/**
  * @file Firebase Security Rules for Saksham Application
  * @version Prototyping
  *
  * @description
  * This ruleset enforces a strict user-ownership model for private user data and enables secure access to learning modules and exams based on grade level.
  * It prioritizes security and correctness while relaxing data validation for rapid prototyping.
  *
  * @data_structure
  * - /users/{userId}: Stores private user profile information.
  * - /learning_modules/{learningModuleId}: Stores learning modules, accessible by grade level.
  * - /exams/{examId}: Stores exam information.
  * - /exams/{examId}/questions/{questionId}: Stores questions associated with an exam.
  * - /users/{userId}/exam_attempts/{studentExamAttemptId}: Stores student exam attempts.
  * - /users/{userId}/exam_attempts/{studentExamAttemptId}/answers/{studentAnswerId}: Stores student answers for a specific exam attempt.
  * - /users/{userId}/accessibility_profile/{accessibilityProfileId}: Stores accessibility profiles.
  *
  * @key_security_decisions
  * - User data is strictly owned by the user; no listing of all users is allowed.
  * - Learning modules and exams are publicly readable, but write access is not yet defined.
  * - Subcollections inherit ownership from their parent documents.
  *
  * @denormalization_for_authorization
  * - StudentExamAttempt documents include userId and examId to avoid needing `get()` calls to validate ownership.
  * - LearningModule and Exam documents include gradeLevel to enable secure list operations.
  *
  * @structural_segregation
  * - User profiles are stored separately from learning modules and exams, ensuring isolation.
  */
 

 rules_version = '2';
 service cloud.firestore {
  match /databases/{database}/documents {
 

   /**
    * @description Controls access to user profile information. Only the authenticated user can read and write their own profile.
    * @path /users/{userId}
    * @allow (create) User with matching {userId} can create their profile.
    * @allow (get, update, delete) Authenticated user with matching {userId} can read, update, and delete their profile.
    * @deny (create, get, update, delete) Any other user attempting to create, read, update, or delete another user's profile.
    * @principle Enforces document ownership for user profiles.
    */
   match /users/{userId} {
    // Check if the user is signed in
    function isSignedIn() {
     return request.auth != null;
    }
 

    // Check if the requested userId matches the authenticated user's UID
    function isOwner(userId) {
     return isSignedIn() && request.auth.uid == userId;
    }
 

    //Check if the user is the owner and the resource exists
    function isExistingOwner(userId) {
     return isOwner(userId) && resource != null;
    }
 

    allow get: if isOwner(userId);
    allow list: if false;
    allow create: if isOwner(userId);
    allow update: if isExistingOwner(userId);
    allow delete: if isExistingOwner(userId);
   }
 

   /**
    * @description Controls access to learning modules.
    * @path /learning_modules/{learningModuleId}
    * @allow (get, list) Anyone can read learning modules.
    * @deny (create, update, delete) Only authorized users can create, update, or delete learning modules.  Write rules are set to false as a placeholder and must be updated with authorization logic.
    * @principle Public read access with restricted write access.
    */
   match /learning_modules/{learningModuleId} {
    allow get, list: if true;
    allow create, update, delete: if false; // TODO: Add authorization for creating, updating, and deleting learning modules.
   }
 

   /**
    * @description Controls access to exams.
    * @path /exams/{examId}
    * @allow (get, list) Anyone can read exam information.
    * @deny (create, update, delete) Only authorized users can create, update, or delete exams. Write rules are set to false as a placeholder and must be updated with authorization logic.
    * @principle Public read access with restricted write access.
    */
   match /exams/{examId} {
    allow get, list: if true;
    allow create, update, delete: if false; // TODO: Add authorization for creating, updating, and deleting exams.
   }
 

   /**
    * @description Controls access to questions associated with an exam.
    * @path /exams/{examId}/questions/{questionId}
    *  @allow (get, list) Anyone can read exam questions.
    * @deny (create, update, delete) Only authorized users can create, update, or delete exam questions.  Write rules are set to false as a placeholder and must be updated with authorization logic.
    * @principle Public read access with restricted write access.
    */
   match /exams/{examId}/questions/{questionId} {
    allow get, list: if true;
    allow create, update, delete: if false; // TODO: Add authorization for creating, updating, and deleting exam questions.
   }
 

   /**
    * @description Controls access to student exam attempts. Only the authenticated user can read and write their own exam attempts.
    * @path /users/{userId}/exam_attempts/{studentExamAttemptId}
    * @allow (create) Authenticated user with matching {userId} can create their exam attempts.
    * @allow (get, update, delete) Authenticated user with matching {userId} can read, update, and delete their exam attempts.
    * @deny (create, get, update, delete) Any other user attempting to create, read, update, or delete another user's exam attempts.
    * @principle Enforces document ownership for student exam attempts.
    */
   match /users/{userId}/exam_attempts/{studentExamAttemptId} {
    // Check if the user is signed in
    function isSignedIn() {
     return request.auth != null;
    }
 

    // Check if the requested userId matches the authenticated user's UID
    function isOwner(userId) {
     return isSignedIn() && request.auth.uid == userId;
    }
 

    //Check if the user is the owner and the resource exists
    function isExistingOwner(userId) {
     return isOwner(userId) && resource != null;
    }
 

    allow get: if isOwner(userId);
    allow list: if isOwner(userId);
    allow create: if isOwner(userId);
    allow update: if isExistingOwner(userId);
    allow delete: if isExistingOwner(userId);
   }
 

   /**
    * @description Controls access to student answers for a specific exam attempt.
    * @path /users/{userId}/exam_attempts/{studentExamAttemptId}/answers/{studentAnswerId}
    * @allow (create) Authenticated user with matching {userId} can create their answers.
    * @allow (get, update, delete) Authenticated user with matching {userId} can read, update, and delete their answers.
    * @deny (create, get, update, delete) Any other user attempting to create, read, update, or delete another user's answers.
    * @principle Enforces document ownership for student answers.
    */
   match /users/{userId}/exam_attempts/{studentExamAttemptId}/answers/{studentAnswerId} {
    // Check if the user is signed in
    function isSignedIn() {
     return request.auth != null;
    }
 

    // Check if the requested userId matches the authenticated user's UID
    function isOwner(userId) {
     return isSignedIn() && request.auth.uid == userId;
    }
 

    //Check if the user is the owner and the resource exists
    function isExistingOwner(userId) {
     return isOwner(userId) && resource != null;
    }
 

    allow get: if isOwner(userId);
    allow list: if isOwner(userId);
    allow create: if isOwner(userId);
    allow update: if isExistingOwner(userId);
    allow delete: if isExistingOwner(userId);
   }
 

   /**
    * @description Controls access to user's accessibility profile. Only the authenticated user can read and write their own profile.
    * @path /users/{userId}/accessibility_profile/{accessibilityProfileId}
    * @allow (create) Authenticated user with matching {userId} can create their profile.
    * @allow (get, update, delete) Authenticated user with matching {userId} can read, update, and delete their profile.
    * @deny (create, get, update, delete) Any other user attempting to create, read, update, or delete another user's profile.
    * @principle Enforces document ownership for accessibility profiles.
    */
   match /users/{userId}/accessibility_profile/{accessibilityProfileId} {
    // Check if the user is signed in
    function isSignedIn() {
     return request.auth != null;
    }
 

    // Check if the requested userId matches the authenticated user's UID
    function isOwner(userId) {
     return isSignedIn() && request.auth.uid == userId;
    }
 

    //Check if the user is the owner and the resource exists
    function isExistingOwner(userId) {
     return isOwner(userId) && resource != null;
    }
 

    allow get: if isOwner(userId);
    allow list: if false;
    allow create: if isOwner(userId);
    allow update: if isExistingOwner(userId);
    allow delete: if isExistingOwner(userId);
   }
  }
 }